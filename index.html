<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Task Manager Pro</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/piexifjs/1.0.6/piexif.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}body{font-family:Inter,sans-serif;background:linear-gradient(135deg,#667eea,#764ba2);min-height:100vh;padding:10px}.container{max-width:520px;margin:0 auto;background:#fff;border-radius:24px;box-shadow:0 20px 60px rgba(0,0,0,.3);overflow:hidden}.header{background:linear-gradient(135deg,#667eea,#764ba2);padding:20px;color:#fff;text-align:center}.header h1{font-size:24px;font-weight:700;margin-bottom:8px}.header p{font-size:13px;opacity:.95}.content{padding:20px}.mode-selector{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:20px}.mode-btn{padding:12px 8px;border:2px solid transparent;border-radius:12px;background:linear-gradient(145deg,#f8f9ff,#e8eaf6);cursor:pointer;text-align:center;font-size:11px;font-weight:700;transition:all .3s;text-transform:uppercase}.mode-btn:hover{transform:translateY(-3px);box-shadow:0 6px 20px rgba(102,126,234,.25)}.mode-btn.active{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;box-shadow:0 8px 25px rgba(102,126,234,.4)}.mode-icon{font-size:24px;display:block;margin-bottom:6px}.upload-btn{padding:14px 24px;background:linear-gradient(135deg,#9c27b0,#ba68c8);color:#fff;border:none;border-radius:12px;font-size:14px;font-weight:700;cursor:pointer;transition:all .3s}.upload-btn:hover{transform:translateY(-2px)}textarea{width:100%;min-height:100px;padding:16px;border:2px solid #e8eaf6;border-radius:12px;font-size:15px;resize:none;font-family:inherit;transition:all .3s}textarea:focus{outline:none;border-color:#667eea;box-shadow:0 0 0 4px rgba(102,126,234,.1)}.btn{width:100%;padding:16px;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;border-radius:12px;font-size:16px;font-weight:700;cursor:pointer;margin-top:12px;transition:all .3s}.btn:hover{transform:translateY(-2px)}.hint{background:linear-gradient(135deg,#fff8e1,#ffecb3);padding:12px 16px;border-radius:10px;font-size:12px;color:#f57c00;margin-top:12px;border-left:4px solid #ff9800;font-weight:600}.list{max-height:450px;overflow-y:auto}.item{display:flex;align-items:center;padding:10px 12px;background:#fff;border:2px solid #f0f0f0;border-radius:10px;margin-bottom:8px;transition:all .3s;min-height:50px}.item:hover{border-color:#667eea;transform:translateY(-2px)}.item.done{background:linear-gradient(135deg,#e8f5e9,#c8e6c9);border-color:#4caf50}.item.warn{background:linear-gradient(135deg,#fff3e0,#ffe0b2);border-color:#ff9800}.item.alert{background:linear-gradient(135deg,#ffebee,#ffcdd2);border-color:#f44336}.item.notfound{background:linear-gradient(135deg,#fff3e0,#ffe0b2);border-color:#ff9800}.item-content{flex-grow:1;min-width:0}.item-name{font-size:14px;font-weight:600;color:#333;line-height:1.5}.item.done .item-name{text-decoration:line-through;color:#999;opacity:.7}.item-qty{font-size:11px;color:#fff;font-weight:800;background:linear-gradient(135deg,#ff6b6b,#ff8e53);padding:3px 8px;border-radius:6px;display:inline-block;margin-right:6px;box-shadow:0 2px 8px rgba(255,107,107,.6);text-transform:uppercase;letter-spacing:.3px;border:2px solid rgba(255,255,255,.8);animation:qtyPulse 2s ease-in-out infinite;vertical-align:middle;white-space:nowrap}.item-qty::before{content:'📦';font-size:12px;margin-right:2px}@keyframes qtyPulse{0%,100%{box-shadow:0 2px 8px rgba(255,107,107,.6)}50%{box-shadow:0 3px 12px rgba(255,107,107,.8)}}.checkbox{width:24px;height:24px;border:2px solid #ddd;border-radius:6px;margin-right:12px;display:flex;align-items:center;justify-content:center;cursor:pointer;background:#fff;flex-shrink:0}.checkbox.checked{background:linear-gradient(135deg,#4caf50,#66bb6a);border-color:#4caf50}.checkmark{display:none;color:#fff;font-size:14px;font-weight:700}.checkbox.checked .checkmark{display:block}.checks{display:flex;gap:5px;margin-left:8px;flex-shrink:0}.check{width:34px;height:34px;border:2px solid #e0e0e0;border-radius:10px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:15px;background:#fff;transition:all .3s;position:relative;flex-shrink:0}.check:hover{transform:scale(1.15)}.check.done{background:linear-gradient(135deg,#4caf50,#66bb6a);color:#fff}.check.warn{background:linear-gradient(135deg,#ff9800,#ffa726);color:#fff}.check.alert{background:linear-gradient(135deg,#f44336,#e57373);color:#fff}.check.blue{background:linear-gradient(135deg,#2196f3,#42a5f5);color:#fff}.check.purple{background:linear-gradient(135deg,#9c27b0,#ba68c8);color:#fff}.check.notfound{background:linear-gradient(135deg,#ff9800,#ffa726);color:#fff}.tooltip{position:absolute;bottom:42px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.9);color:#fff;padding:6px 12px;border-radius:6px;font-size:10px;white-space:nowrap;opacity:0;pointer-events:none;transition:opacity .3s;font-weight:600;z-index:100}.check:hover .tooltip{opacity:1}.del-btn{width:32px;height:32px;border-radius:8px;background:linear-gradient(135deg,#ffebee,#ffcdd2);border:none;color:#f44336;font-size:18px;cursor:pointer;opacity:0;margin-left:10px;transition:all .3s;flex-shrink:0}.item:hover .del-btn{opacity:1}.del-btn:hover{transform:scale(1.15);background:linear-gradient(135deg,#f44336,#e57373);color:#fff}.empty{text-align:center;padding:50px 20px;color:#999}.empty-icon{font-size:60px;opacity:.5;margin-bottom:15px}.empty p{font-size:16px;font-weight:600}.actions{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:15px}.action-btn{padding:12px;background:#fff;color:#667eea;border:2px solid #667eea;border-radius:10px;font-size:13px;font-weight:700;cursor:pointer;transition:all .3s;text-transform:uppercase}.action-btn:hover{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;transform:translateY(-2px)}.action-btn.danger{color:#f44336;border-color:#f44336}.action-btn.danger:hover{background:linear-gradient(135deg,#f44336,#e57373)}.action-btn.success{color:#10a37f;border-color:#10a37f}.action-btn.success:hover{background:linear-gradient(135deg,#10a37f,#0d8f6f)}.stats{display:flex;justify-content:space-between;padding:10px 12px;background:#f8f9ff;border-radius:14px;margin-bottom:15px;gap:8px}.stat{text-align:center;min-width:55px}.stat-number{font-size:20px;font-weight:700;color:#667eea;display:block}.stat-label{font-size:9px;color:#666;text-transform:uppercase;font-weight:700;margin-top:2px;white-space:nowrap}.progress-bar{height:6px;background:#e0e0e0;border-radius:10px;margin:12px 0;overflow:hidden}.progress-fill{height:100%;background:linear-gradient(90deg,#4caf50,#8bc34a);transition:width .6s;border-radius:10px}.loading{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.85);display:none;justify-content:center;align-items:center;z-index:9999}.loading.show{display:flex}.loading-content{background:#fff;padding:40px;border-radius:20px;text-align:center}.spinner{width:60px;height:60px;border:6px solid #f3f3f3;border-top:6px solid #667eea;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 20px}@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}.loading-text{font-size:16px;color:#333;font-weight:700}.metadata-section{padding:20px;background:#f8f9ff;border-radius:16px;margin-bottom:15px}.metadata-step{background:#fff;padding:20px;border-radius:12px;margin-bottom:15px;border:2px solid #e8eaf6}.metadata-step-number{display:inline-block;width:32px;height:32px;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border-radius:50%;text-align:center;line-height:32px;font-weight:700;margin-right:10px}.metadata-step-title{font-size:15px;font-weight:700;color:#333;margin-bottom:10px}.metadata-upload-area{text-align:center;padding:30px;border:3px dashed #667eea;border-radius:12px;background:#fff;transition:all .3s}.metadata-upload-area:hover{border-color:#764ba2;background:#f8f9ff}.metadata-preview{background:#fff;padding:20px;border-radius:12px;margin-bottom:15px;border:2px solid #e8eaf6}.metadata-title{color:#667eea;font-size:16px;font-weight:700;margin-bottom:15px}.metadata-info{font-size:13px;color:#333;line-height:1.8}.metadata-row{display:flex;padding:8px 0;border-bottom:1px solid #f0f0f0}.metadata-row:last-child{border-bottom:none}.metadata-label{font-weight:700;color:#667eea;min-width:120px}.metadata-value{color:#666;flex:1}.warehouse-num{width:34px;height:34px;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:15px;margin-right:14px;flex-shrink:0}.msg-box{background:#f8f9ff;border:2px solid #667eea;border-radius:14px;padding:18px;margin-bottom:15px;font-size:13px;white-space:pre-wrap;font-family:monospace;line-height:1.6}.legend{background:#f8f9ff;padding:14px;border-radius:12px;margin-bottom:15px;font-size:12px}.legend-item{display:flex;align-items:center;gap:10px;margin-bottom:8px;font-weight:600}.legend-item:last-child{margin-bottom:0}.legend-icon{width:18px;height:18px;border-radius:5px;color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;flex-shrink:0}.notice{background:linear-gradient(135deg,#e3f2fd,#bbdefb);padding:12px 16px;border-radius:10px;font-size:12px;color:#1976d2;margin-bottom:15px;border-left:4px solid #2196f3;font-weight:600}.location-input{width:100%;padding:14px;border:2px solid #e8eaf6;border-radius:10px;font-size:14px;margin-bottom:12px;transition:all .3s;font-family:inherit}.location-input:focus{outline:none;border-color:#667eea;box-shadow:0 0 0 4px rgba(102,126,234,.1)}.location-label{font-size:13px;font-weight:700;color:#667eea;margin-bottom:8px;display:block;text-transform:uppercase}.counter-result{background:linear-gradient(135deg,#667eea,#764ba2);padding:30px 20px;border-radius:16px;margin-bottom:15px;box-shadow:0 8px 25px rgba(102,126,234,.4)}.counter-main{text-align:center;margin-bottom:20px}.counter-number{font-size:72px;font-weight:700;color:#fff;display:block;margin-bottom:10px}.counter-label{font-size:20px;color:#fff;font-weight:600;text-transform:uppercase}.counter-details{background:rgba(255,255,255,.15);padding:20px;border-radius:12px;display:grid;grid-template-columns:repeat(2,1fr);gap:15px}.counter-detail-item{color:#fff;text-align:center;padding:15px;background:rgba(255,255,255,.1);border-radius:10px}.counter-detail-number{font-size:28px;font-weight:700;display:block;margin-bottom:5px}.counter-detail-label{font-size:12px;opacity:.9;text-transform:uppercase}@media(max-width:480px){.mode-selector{grid-template-columns:repeat(2,1fr)}.item-qty{font-size:10px;padding:2px 6px}}
</style>
</head>
<body>
<div class="loading" id="loading"><div class="loading-content"><div class="spinner"></div><div class="loading-text" id="loadingText">Caricamento...</div></div></div>
<div class="container">
<div class="header"><h1>📋 Task Manager Pro</h1><p>6 modalità complete per gestire ogni attività</p></div>
<div class="content">
<div class="mode-selector">
<div class="mode-btn active" onclick="app.setMode('shopping',event)"><span class="mode-icon">✅</span>Lista</div>
<div class="mode-btn" onclick="app.setMode('testing',event)"><span class="mode-icon">🔧</span>Collaudi</div>
<div class="mode-btn" onclick="app.setMode('photos',event)"><span class="mode-icon">📷</span>Foto</div>
<div class="mode-btn" onclick="app.setMode('warehouse',event)"><span class="mode-icon">📦</span>Magazzino</div>
<div class="mode-btn" onclick="app.setMode('counter',event)"><span class="mode-icon">🔢</span>Conteggio</div>
<div class="mode-btn" onclick="app.setMode('metadata',event)"><span class="mode-icon">🏷️</span>Metadati</div>
</div>
<div id="inputSection">
<div style="display:flex;gap:10px;margin-bottom:15px;justify-content:center">
<label for="photoUpload" class="upload-btn">📸 Carica Foto</label>
<input type="file" id="photoUpload" style="display:none" accept="image/*">
</div>
<textarea id="messageInput" placeholder=""></textarea>
<div class="hint" id="hint"></div>
<button class="btn" onclick="app.create()" id="mainBtn">✨ Crea Lista</button>
</div>
<div id="metadataSection" style="display:none" class="metadata-section">
<div class="metadata-step">
<div class="metadata-step-title"><span class="metadata-step-number">1</span>Carica Foto Sorgente</div>
<div class="metadata-upload-area">
<label for="sourcePhoto" class="upload-btn" style="display:inline-block">📥 Seleziona Foto</label>
<input type="file" id="sourcePhoto" style="display:none" accept="image/*">
<p style="color:#999;font-size:12px;margin-top:10px">Foto da cui estrarre metadati EXIF</p>
</div>
</div>
<div id="metadataPreview" style="display:none" class="metadata-preview">
<div class="metadata-title">✅ Metadati Estratti</div>
<div class="metadata-info" id="metadataInfo"></div>
</div>
<div id="gpsManualSection" style="display:none" class="metadata-step">
<div class="metadata-step-title"><span class="metadata-step-number">2</span>Aggiungi Coordinate GPS (Opzionale)</div>
<div style="background:#fff;padding:20px;border-radius:12px">
<div style="margin-bottom:15px">
<label style="display:block;font-weight:700;color:#667eea;margin-bottom:5px;font-size:13px">🌍 Latitudine:</label>
<input type="text" id="gpsLat" class="location-input" placeholder="Es: 41.0082" style="margin-bottom:0">
<p style="color:#999;font-size:11px;margin-top:5px">Formato decimale (es: 41.0082 per Roma)</p>
</div>
<div style="margin-bottom:15px">
<label style="display:block;font-weight:700;color:#667eea;margin-bottom:5px;font-size:13px">🌍 Longitudine:</label>
<input type="text" id="gpsLon" class="location-input" placeholder="Es: 28.9784" style="margin-bottom:0">
<p style="color:#999;font-size:11px;margin-top:5px">Formato decimale (es: 28.9784 per Istanbul)</p>
</div>
<button class="btn" onclick="app.applyGpsToSource()" style="margin-top:10px">📍 Applica GPS alla Foto</button>
</div>
</div>
<div id="targetStep" style="display:none" class="metadata-step">
<div class="metadata-step-title"><span class="metadata-step-number">3</span>Applica a Destinazione</div>
<div class="metadata-upload-area">
<label for="targetPhoto" class="upload-btn" style="display:inline-block">📤 Seleziona Foto</label>
<input type="file" id="targetPhoto" style="display:none" accept="image/*">
<p style="color:#999;font-size:12px;margin-top:10px">Verrà scaricata con metadati applicati</p>
</div>
</div>
</div>
<div id="notice" style="display:none" class="notice"></div>
<div id="locationSection" style="display:none">
<label class="location-label">📍 Luogo</label>
<input type="text" id="locationInput" class="location-input" placeholder="Es: Cantiere Nord...">
</div>
<div id="actionSection" style="display:none">
<div class="actions">
<button class="action-btn" onclick="app.addMore()">➕ Aggiungi</button>
<button class="action-btn" onclick="app.reset()">↺ Reset</button>
<button class="action-btn danger" onclick="app.clear()">🗑️ Cancella</button>
<button class="action-btn success" id="excelBtn" onclick="app.exportExcel()">📊 Excel</button>
</div>
<div style="position:relative">
<input type="text" id="searchBox" class="search-box" placeholder="Cerca elemento nella lista..." oninput="app.filterItems()">
<span id="searchCount" style="position:absolute;right:16px;top:50%;transform:translateY(-50%);font-size:12px;color:#667eea;font-weight:700;display:none"></span>
</div>
</div>
<div id="counterResult" style="display:none"></div>
<div id="warehouseMsg" style="display:none"><div class="msg-box" id="msgPreview"></div></div>
<div id="legendSection" style="display:none"></div>
<div id="statsSection" style="display:none"></div>
<div id="list" class="list"><div class="empty"><div class="empty-icon">📝</div><p>Seleziona una modalità per iniziare</p></div></div>
</div>
</div>
<script>
window.app={mode:'shopping',data:{shopping:[],testing:[],photos:[],warehouse:[]},location:'',sourceMetadata:null,searchQuery:'',init(){const s=localStorage.getItem('taskData');if(s)this.data=JSON.parse(s);this.setupEvents();this.loadMode()},setupEvents(){document.getElementById('photoUpload').onchange=e=>this.handlePhoto(e);document.getElementById('locationInput').onchange=()=>{this.location=document.getElementById('locationInput').value;this.save()};const src=document.getElementById('sourcePhoto');const tgt=document.getElementById('targetPhoto');if(src)src.onchange=e=>this.loadSourceMetadata(e);if(tgt)tgt.onchange=e=>this.applyMetadataToTarget(e)},setMode(m,evt){this.mode=m;document.querySelectorAll('.mode-btn').forEach(b=>b.classList.remove('active'));if(evt&&evt.target){evt.target.closest('.mode-btn').classList.add('active')}const inp=document.getElementById('messageInput'),hint=document.getElementById('hint'),btn=document.getElementById('mainBtn');const ph={'shopping':'Lista cose da fare...\n\nEs:\n2 pani\nlatte 2L\n3 secchi','testing':'Elenco collaudi...','photos':'Elenco foto...','warehouse':'Materiale magazzino...','counter':'Testo da contare...','metadata':''};const ht={'shopping':'💡 Scrivi un elemento per riga!','testing':'💡 Scrivi un collaudo per riga!','photos':'💡 Scrivi una foto per riga!','warehouse':'💡 Scrivi un materiale per riga!','counter':'💡 Incolla il testo!','metadata':'💡 Trasferisci metadati EXIF in 2 passaggi!'};const bt={'shopping':'✨ Crea Lista','testing':'✨ Crea Collaudi','photos':'✨ Crea Foto','warehouse':'✨ Crea Richiesta','counter':'🔢 Conta','metadata':''};inp.placeholder=ph[m]||'';hint.innerHTML=ht[m]||'';btn.textContent=bt[m]||'Crea';this.loadMode()},getItems(){return this.data[this.mode]||[]},setItems(items){this.data[this.mode]=items;this.save()},save(){localStorage.setItem('taskData',JSON.stringify(this.data))},create(){if(this.mode==='counter'){this.count();return}if(this.mode==='metadata')return;const inp=document.getElementById('messageInput').value;if(!inp.trim()){alert('📝 Inserisci prima i dati!');return}const lines=inp.split('\n').filter(l=>l.trim());let items=[];if(this.mode==='warehouse'){lines.forEach(l=>{const p=this.parseItem(l);items.push({name:p.name,qty:p.qty})})}else if(this.mode==='shopping'){lines.forEach(l=>{const p=this.parseItem(l);items.push({name:p.name,qty:p.qty,checked:false,notfound:false})})}else if(this.mode==='testing'){lines.forEach(l=>{items.push({name:this.capitalize(l),done:false,label:false,help:false})})}else if(this.mode==='photos'){lines.forEach(l=>{items.push({name:this.capitalize(l),photo:false,cable:false,empty:false,merged:false})})}const unique=this.removeDuplicates(items);const dupes=items.length-unique.length;this.setItems(unique);if(this.mode==='testing'||this.mode==='photos'){const sorted=this.getItems().sort((a,b)=>a.name.localeCompare(b.name,'it'));this.setItems(sorted)}if(dupes>0){document.getElementById('notice').textContent='ℹ️ Rimossi '+dupes+' duplicat'+(dupes>1?'i':'o');document.getElementById('notice').style.display='block';setTimeout(()=>{document.getElementById('notice').style.display='none'},5000)}this.loadMode()},addMore(){document.getElementById('inputSection').style.display='block';document.getElementById('actionSection').style.display='none';document.getElementById('list').style.display='none';document.getElementById('statsSection').style.display='none';document.getElementById('legendSection').style.display='none';document.getElementById('locationSection').style.display='none';document.getElementById('warehouseMsg').style.display='none';document.getElementById('messageInput').focus()},filterItems(){this.searchQuery=document.getElementById('searchBox').value.toLowerCase();this.render()},count(){const inp=document.getElementById('messageInput').value;if(!inp.trim()){alert('📝 Inserisci prima il testo!');return}const lines=inp.split('\n').filter(l=>l.trim());const words=inp.trim().split(/\s+/).filter(w=>w);const chars=inp.length;const charsNoSpaces=inp.replace(/\s/g,'').length;let html='<div class="counter-result"><div class="counter-main"><div class="counter-number">'+lines.length+'</div><div class="counter-label">🔢 Elementi Trovati</div></div><div class="counter-details"><div class="counter-detail-item"><span class="counter-detail-number">'+lines.length+'</span><span class="counter-detail-label">📝 Righe</span></div><div class="counter-detail-item"><span class="counter-detail-number">'+words.length+'</span><span class="counter-detail-label">📖 Parole</span></div><div class="counter-detail-item"><span class="counter-detail-number">'+chars+'</span><span class="counter-detail-label">🔤 Caratteri</span></div><div class="counter-detail-item"><span class="counter-detail-number">'+charsNoSpaces+'</span><span class="counter-detail-label">🔡 Senza Spazi</span></div></div></div>';document.getElementById('counterResult').innerHTML=html;document.getElementById('counterResult').style.display='block';document.getElementById('list').style.display='none'},parseItem(line){const matchWithUnit=line.match(/^(.+?)\s+(\d+[\.,]?\d*\s*(?:kg|g|l|ml|pz|mt|litri|litro|pezzi|pezzo|scatole|scatola|pacco|pacchi))\s*$/i);if(matchWithUnit){return{name:this.capitalize(matchWithUnit[1]),qty:matchWithUnit[2].toUpperCase()}}const matchNumber=line.match(/^(\d+[\.,]?\d*)\s+(.+)$/);if(matchNumber){return{name:this.capitalize(matchNumber[2]),qty:matchNumber[1]}}return{name:this.capitalize(line),qty:null}},capitalize(str){return str.split(' ').map(w=>w.length>2?w.charAt(0).toUpperCase()+w.slice(1).toLowerCase():w.toLowerCase()).join(' ')},removeDuplicates(items){const seen=new Set();return items.filter(item=>{const key=item.name.toLowerCase();if(seen.has(key))return false;seen.add(key);return true})},loadMode(){if(this.mode==='metadata'){document.getElementById('inputSection').style.display='none';document.getElementById('actionSection').style.display='none';document.getElementById('statsSection').style.display='none';document.getElementById('legendSection').style.display='none';document.getElementById('locationSection').style.display='none';document.getElementById('warehouseMsg').style.display='none';document.getElementById('counterResult').style.display='none';document.getElementById('list').style.display='none';document.getElementById('metadataSection').style.display='block';return}document.getElementById('metadataSection').style.display='none';if(this.mode==='counter'){document.getElementById('inputSection').style.display='block';document.getElementById('actionSection').style.display='none';document.getElementById('statsSection').style.display='none';document.getElementById('legendSection').style.display='none';document.getElementById('locationSection').style.display='none';document.getElementById('warehouseMsg').style.display='none';document.getElementById('counterResult').style.display='none';document.getElementById('list').innerHTML='<div class="empty"><div class="empty-icon">🔢</div><p>Inserisci il testo da contare</p></div>';document.getElementById('list').style.display='block';return}const items=this.getItems();if(items.length>0){document.getElementById('inputSection').style.display='none';document.getElementById('actionSection').style.display='block';document.getElementById('counterResult').style.display='none';document.getElementById('list').style.display='block';document.getElementById('searchBox').value='';this.searchQuery='';if(this.mode==='testing'||this.mode==='photos'){document.getElementById('locationSection').style.display='block';document.getElementById('legendSection').style.display='block';document.getElementById('excelBtn').style.display='block';this.updateLegend()}else if(this.mode==='warehouse'){document.getElementById('warehouseMsg').style.display='block';document.getElementById('excelBtn').style.display='none';document.getElementById('locationSection').style.display='none';document.getElementById('legendSection').style.display='none';this.updateMsg()}else{document.getElementById('locationSection').style.display='none';document.getElementById('legendSection').style.display='none';document.getElementById('warehouseMsg').style.display='none';document.getElementById('excelBtn').style.display='none'}this.updateStats();this.render()}else{document.getElementById('inputSection').style.display='block';document.getElementById('actionSection').style.display='none';document.getElementById('statsSection').style.display='none';document.getElementById('legendSection').style.display='none';document.getElementById('locationSection').style.display='none';document.getElementById('warehouseMsg').style.display='none';document.getElementById('counterResult').style.display='none';document.getElementById('list').innerHTML='<div class="empty"><div class="empty-icon">📝</div><p>Inserisci i dati per iniziare</p></div>';document.getElementById('list').style.display='block'}},updateLegend(){let h='<div class="legend">';if(this.mode==='testing'){h+='<div class="legend-item"><div class="legend-icon" style="background:#4caf50">✓</div><span><strong>Verde:</strong> Completato</span></div>';h+='<div class="legend-item"><div class="legend-icon" style="background:#ff9800">🏷</div><span><strong>Arancio:</strong> Manca Label</span></div>';h+='<div class="legend-item"><div class="legend-icon" style="background:#f44336">❗</div><span><strong>Rosso:</strong> Da chiarire</span></div>'}else if(this.mode==='photos'){h+='<div class="legend-item"><div class="legend-icon" style="background:#4caf50">✓</div><span><strong>Verde:</strong> Foto fatta</span></div>';h+='<div class="legend-item"><div class="legend-icon" style="background:#2196f3">🎞</div><span><strong>Blu:</strong> Cavo roccetta</span></div>';h+='<div class="legend-item"><div class="legend-icon" style="background:#ff9800">○</div><span><strong>Arancio:</strong> Vuoto</span></div>';h+='<div class="legend-item"><div class="legend-icon" style="background:#9c27b0">⊕</div><span><strong>Viola:</strong> Accorpato</span></div>'}h+='</div>';document.getElementById('legendSection').innerHTML=h},updateMsg(){const items=this.getItems();let msg='📦 RICHIESTA MATERIALE MAGAZZINO\n\nBuongiorno,\nho bisogno del seguente materiale:\n\n';items.forEach((item,i)=>{msg+=(i+1)+'. '+item.name;if(item.qty)msg+=' - '+item.qty;msg+='\n'});msg+='\nGrazie mille';document.getElementById('msgPreview').textContent=msg},updateStats(){const items=this.getItems();const total=items.length;let html='<div class="stats">';if(this.mode==='testing'){const done=items.filter(i=>i.done&&!i.label&&!i.help).length;const label=items.filter(i=>i.label).length;const help=items.filter(i=>i.help).length;const none=total-done-label-help;html+='<div class="stat"><span class="stat-number">'+total+'</span><span class="stat-label">Totale</span></div>';html+='<div class="stat"><span class="stat-number" style="color:#4caf50">'+done+'</span><span class="stat-label">Fatti</span></div>';html+='<div class="stat"><span class="stat-number" style="color:#ff9800">'+label+'</span><span class="stat-label">No Label</span></div>';html+='<div class="stat"><span class="stat-number" style="color:#f44336">'+help+'</span><span class="stat-label">Da Chiarire</span></div>';html+='<div class="stat"><span class="stat-number" style="color:#9e9e9e">'+none+'</span><span class="stat-label">Non Iniziati</span></div>';html+='</div><div class="progress-bar"><div class="progress-fill" style="width:'+(total>0?(done/total)*100:0)+'%"></div></div>'}else if(this.mode==='photos'){const done=items.filter(i=>i.photo).length;const cable=items.filter(i=>i.cable).length;const empty=items.filter(i=>i.empty).length;const merged=items.filter(i=>i.merged).length;html+='<div class="stat"><span class="stat-number">'+total+'</span><span class="stat-label">Totale</span></div>';html+='<div class="stat"><span class="stat-number" style="color:#4caf50">'+done+'</span><span class="stat-label">Fatte</span></div>';html+='<div class="stat"><span class="stat-number" style="color:#2196f3">'+cable+'</span><span class="stat-label">Roccetta</span></div>';html+='<div class="stat"><span class="stat-number" style="color:#ff9800">'+empty+'</span><span class="stat-label">Vuoto</span></div>';html+='<div class="stat"><span class="stat-number" style="color:#9c27b0">'+merged+'</span><span class="stat-label">Accorpato</span></div>';html+='</div><div class="progress-bar"><div class="progress-fill" style="width:'+(total>0?(done/total)*100:0)+'%"></div></div>'}else{const done=items.filter(i=>i.checked).length;const left=total-done;const notfound=items.filter(i=>i.notfound).length;html+='<div class="stat"><span class="stat-number">'+total+'</span><span class="stat-label">Totale</span></div>';html+='<div class="stat"><span class="stat-number">'+done+'</span><span class="stat-label">Presi</span></div>';html+='<div class="stat"><span class="stat-number">'+left+'</span><span class="stat-label">Mancanti</span></div>';html+='<div class="stat"><span class="stat-number" style="color:#ff9800">'+notfound+'</span><span class="stat-label">Non Trovati</span></div>';html+='</div><div class="progress-bar"><div class="progress-fill" style="width:'+(total>0?(done/total)*100:0)+'%"></div></div>'}document.getElementById('statsSection').innerHTML=html;document.getElementById('statsSection').style.display='block'},render(){const items=this.getItems();const searchQuery=this.searchQuery||'';const filteredItems=searchQuery?items.filter((item,i)=>{item._originalIndex=i;return item.name.toLowerCase().includes(searchQuery)}):items.map((item,i)=>{item._originalIndex=i;return item});let html='';if(this.mode==='warehouse'){filteredItems.forEach((item)=>{const i=item._originalIndex;html+='<div class="item"><div class="warehouse-num">'+(i+1)+'</div><div class="item-content">';if(item.qty)html+='<div class="item-qty">📦 '+item.qty+'</div>';html+='<div class="item-name">'+item.name+'</div></div><button class="del-btn" onclick="app.del('+i+',event)">×</button></div>'})}else if(this.mode==='shopping'){filteredItems.forEach((item)=>{const i=item._originalIndex;let cls='';if(item.checked)cls='done';else if(item.notfound)cls='notfound';html+='<div class="item '+cls+'" onclick="app.toggle('+i+')">';html+='<div class="checkbox '+(item.checked?'checked':'')+'"><span class="checkmark">✓</span></div>';html+='<div class="item-content">';html+='<div class="item-name">';if(item.qty)html+='<span class="item-qty">'+item.qty+'</span>';html+=item.name+'</div></div>';html+='<div class="checks">';html+='<div class="check '+(item.notfound?'notfound':'')+'" onclick="app.toggleNotFound('+i+',event)" style="margin-left:8px">'+(item.notfound?'✗':'○')+'<div class="tooltip">Non Trovato</div></div>';html+='</div>';html+='<button class="del-btn" onclick="app.del('+i+',event)">×</button></div>'})}else if(this.mode==='testing'){filteredItems.forEach((item)=>{const i=item._originalIndex;let cls='';if(item.done&&!item.label&&!item.help)cls='done';else if(item.help)cls='alert';else if(item.label)cls='warn';html+='<div class="item '+cls+'"><div class="item-content"><div class="item-name">'+item.name+'</div></div><div class="checks">';html+='<div class="check '+(item.done?'done':'')+'" onclick="app.toggleCheck('+i+',\'done\')">'+(item.done?'✓':'○')+'<div class="tooltip">Completato</div></div>';html+='<div class="check '+(item.label?'warn':'')+'" onclick="app.toggleCheck('+i+',\'label\')">'+(item.label?'🏷️':'🏷')+'<div class="tooltip">Manca Label</div></div>';html+='<div class="check '+(item.help?'alert':'')+'" onclick="app.toggleCheck('+i+',\'help\')">'+(item.help?'❗':'?')+'<div class="tooltip">Da Chiarire</div></div></div>';html+='<button class="del-btn" onclick="app.del('+i+',event)">×</button></div>'})}else if(this.mode==='photos'){filteredItems.forEach((item)=>{const i=item._originalIndex;let cls='';if(item.photo&&!item.cable&&!item.empty&&!item.merged)cls='done';html+='<div class="item '+cls+'"><div class="item-content"><div class="item-name">'+item.name+'</div></div><div class="checks">';html+='<div class="check '+(item.photo?'done':'')+'" onclick="app.toggleCheck('+i+',\'photo\')">'+(item.photo?'✓':'○')+'<div class="tooltip">Foto Fatta</div></div>';html+='<div class="check '+(item.cable?'blue':'')+'" onclick="app.toggleCheck('+i+',\'cable\')">'+(item.cable?'🎞':'○')+'<div class="tooltip">Cavo Roccetta</div></div>';html+='<div class="check '+(item.empty?'warn':'')+'" onclick="app.toggleCheck('+i+',\'empty\')">○<div class="tooltip">Pozzetto Vuoto</div></div>';html+='<div class="check '+(item.merged?'purple':'')+'" onclick="app.toggleCheck('+i+',\'merged\')">'+(item.merged?'⊕':'○')+'<div class="tooltip">Accorpato</div></div></div>';html+='<button class="del-btn" onclick="app.del('+i+',event)">×</button></div>'})}if(searchQuery&&filteredItems.length===0){html='<div class="empty"><div class="empty-icon">🔍</div><p>Nessun risultato per "'+searchQuery+'"</p></div>'}document.getElementById('list').innerHTML=html},toggle(i){const items=this.getItems();items[i].checked=!items[i].checked;this.setItems(items);this.render();this.updateStats();if(items.every(item=>item.checked)){setTimeout(()=>{if(confirm('🎉 Hai completato tutto!\n\nVuoi cancellare la lista?'))this.clear()},300)}},toggleCheck(i,prop){const items=this.getItems();items[i][prop]=!items[i][prop];this.setItems(items);this.render();this.updateStats()},toggleNotFound(i,evt){evt.stopPropagation();const items=this.getItems();items[i].notfound=!items[i].notfound;this.setItems(items);this.render();this.updateStats()},del(i,evt){evt.stopPropagation();const items=this.getItems();items.splice(i,1);this.setItems(items);if(items.length===0)this.reset();else{this.render();if(this.mode==='warehouse')this.updateMsg();else this.updateStats()}},reset(){const items=this.getItems();if(items.length===0){this.setItems([]);document.getElementById('messageInput').value='';document.getElementById('locationInput').value='';this.location='';document.getElementById('notice').style.display='none';document.getElementById('counterResult').style.display='none';document.getElementById('list').style.display='block';this.save();this.loadMode();return}if(this.mode==='shopping'){items.forEach(item=>{item.checked=false;item.notfound=false})}else if(this.mode==='testing'){items.forEach(item=>{item.done=false;item.label=false;item.help=false})}else if(this.mode==='photos'){items.forEach(item=>{item.photo=false;item.cable=false;item.empty=false;item.merged=false})}this.setItems(items);this.render();this.updateStats()},clear(){if(confirm('🗑️ Sei sicuro di voler cancellare tutto?')){this.setItems([]);this.searchQuery='';document.getElementById('messageInput').value='';document.getElementById('locationInput').value='';document.getElementById('searchBox').value='';this.location='';document.getElementById('notice').style.display='none';document.getElementById('counterResult').style.display='none';document.getElementById('list').style.display='block';this.save();this.loadMode()}},exportExcel(){if(this.mode==='testing'){const loc=document.getElementById('locationInput').value||'Non specificato';const data=[['Nome Collaudo','Stato','Luogo']];this.getItems().forEach(item=>{const stats=[];if(item.done)stats.push('✓ Fatto');if(item.label)stats.push('🏷 Manca Label');if(item.help)stats.push('❗ Da Chiarire');data.push([item.name,stats.join(', ')||'Da fare',loc])});const ws=XLSX.utils.aoa_to_sheet(data);ws['!cols']=[{wch:40},{wch:30},{wch:25}];const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,'Collaudi');XLSX.writeFile(wb,'Collaudi_'+new Date().toLocaleDateString('it-IT').replace(/\//g,'-')+'.xlsx')}else if(this.mode==='photos'){const loc=document.getElementById('locationInput').value||'Non specificato';const data=[['Nome Foto','Stato','Luogo']];this.getItems().forEach(item=>{const stats=[];if(item.photo)stats.push('✓ Foto Fatta');if(item.cable)stats.push('🎞 Cavo Roccetta');if(item.empty)stats.push('○ Vuoto');if(item.merged)stats.push('⊕ Accorpato');data.push([item.name,stats.join(', ')||'Da fare',loc])});const ws=XLSX.utils.aoa_to_sheet(data);ws['!cols']=[{wch:40},{wch:30},{wch:25}];const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,'Foto');XLSX.writeFile(wb,'Foto_'+new Date().toLocaleDateString('it-IT').replace(/\//g,'-')+'.xlsx')}},handlePhoto(e){const file=e.target.files[0];if(!file)return;if(!file.type.startsWith('image/')){alert('⚠️ Per favore carica solo immagini!');return}document.getElementById('loading').classList.add('show');document.getElementById('loadingText').textContent='Lettura in corso...';Tesseract.recognize(file,'ita',{logger:m=>{if(m.status==='recognizing text'){const pct=Math.round(m.progress*100);document.getElementById('loadingText').textContent='Lettura in corso... '+pct+'%'}}}).then(({data:{text}})=>{document.getElementById('loading').classList.remove('show');document.getElementById('messageInput').value=text;e.target.value='';alert('✅ Foto letta con successo!\n\nControlla il testo e premi il pulsante.')}).catch(err=>{document.getElementById('loading').classList.remove('show');alert('❌ Errore durante la lettura della foto.');console.error(err);e.target.value=''})},loadSourceMetadata(e){const file=e.target.files[0];if(!file)return;document.getElementById('loading').classList.add('show');document.getElementById('loadingText').textContent='Estrazione metadati...';const reader=new FileReader();reader.onload=ev=>{try{const exifData=piexif.load(ev.target.result);this.sourceMetadata={file:file,exifBytes:piexif.dump(exifData),exifData:exifData,originalDataUrl:ev.target.result};let html='';html+='<div class="metadata-row"><span class="metadata-label">📄 Nome:</span><span class="metadata-value">'+file.name+'</span></div>';html+='<div class="metadata-row"><span class="metadata-label">📏 Dimensione:</span><span class="metadata-value">'+(file.size/1024).toFixed(2)+' KB</span></div>';html+='<div class="metadata-row"><span class="metadata-label">🖼️ Tipo:</span><span class="metadata-value">'+file.type+'</span></div>';if(exifData['0th']&&exifData['0th'][piexif.ImageIFD.Make]){html+='<div class="metadata-row"><span class="metadata-label">📷 Marca:</span><span class="metadata-value">'+exifData['0th'][piexif.ImageIFD.Make]+'</span></div>'}if(exifData['0th']&&exifData['0th'][piexif.ImageIFD.Model]){html+='<div class="metadata-row"><span class="metadata-label">📱 Modello:</span><span class="metadata-value">'+exifData['0th'][piexif.ImageIFD.Model]+'</span></div>'}if(exifData['Exif']&&exifData['Exif'][piexif.ExifIFD.DateTimeOriginal]){html+='<div class="metadata-row"><span class="metadata-label">📅 Data:</span><span class="metadata-value">'+exifData['Exif'][piexif.ExifIFD.DateTimeOriginal]+'</span></div>'}if(exifData['GPS']&&exifData['GPS'][piexif.GPSIFD.GPSLatitude]){html+='<div class="metadata-row"><span class="metadata-label">🌍 GPS:</span><span class="metadata-value">Coordinate presenti</span></div>'}else{html+='<div class="metadata-row"><span class="metadata-label">🌍 GPS:</span><span class="metadata-value" style="color:#ff9800">Non presente</span></div>'}document.getElementById('metadataInfo').innerHTML=html;document.getElementById('metadataPreview').style.display='block';document.getElementById('gpsManualSection').style.display='block';document.getElementById('targetStep').style.display='block';document.getElementById('loading').classList.remove('show');alert('✅ Metadati EXIF estratti!\n\nPuoi aggiungere coordinate GPS o procedere al passo 3.')}catch(err){console.error(err);document.getElementById('loading').classList.remove('show');alert('⚠️ Nessun metadato EXIF trovato.\n\nProva con un\'altra foto.')}e.target.value=''};reader.readAsDataURL(file)},applyGpsToSource(){const lat=document.getElementById('gpsLat').value.trim();const lon=document.getElementById('gpsLon').value.trim();if(!lat||!lon){alert('⚠️ Inserisci sia latitudine che longitudine!');return}const latNum=parseFloat(lat);const lonNum=parseFloat(lon);if(isNaN(latNum)||isNaN(lonNum)){alert('⚠️ Coordinate non valide!\n\nUsa il formato decimale (es: 41.0082)');return}if(latNum<-90||latNum>90||lonNum<-180||lonNum>180){alert('⚠️ Coordinate fuori range!\n\nLatitudine: -90 a 90\nLongitudine: -180 a 180');return}if(!this.sourceMetadata){alert('⚠️ Carica prima una foto!');return}document.getElementById('loading').classList.add('show');document.getElementById('loadingText').textContent='Applicazione GPS...';try{const exifData=this.sourceMetadata.exifData;const latDeg=Math.abs(latNum);const latMin=(latDeg%1)*60;const latSec=(latMin%1)*60;const lonDeg=Math.abs(lonNum);const lonMin=(lonDeg%1)*60;const lonSec=(lonMin%1)*60;if(!exifData.GPS){exifData.GPS={}}exifData.GPS[piexif.GPSIFD.GPSLatitudeRef]=latNum>=0?'N':'S';exifData.GPS[piexif.GPSIFD.GPSLatitude]=[[Math.floor(latDeg),1],[Math.floor(latMin),1],[Math.round(latSec*100),100]];exifData.GPS[piexif.GPSIFD.GPSLongitudeRef]=lonNum>=0?'E':'W';exifData.GPS[piexif.GPSIFD.GPSLongitude]=[[Math.floor(lonDeg),1],[Math.floor(lonMin),1],[Math.round(lonSec*100),100]];const exifBytes=piexif.dump(exifData);const inserted=piexif.insert(exifBytes,this.sourceMetadata.originalDataUrl);this.sourceMetadata.exifBytes=exifBytes;this.sourceMetadata.exifData=exifData;const link=document.createElement('a');link.href=inserted;link.download='foto_con_gps_'+new Date().getTime()+'.jpg';link.click();document.getElementById('loading').classList.remove('show');alert('✅ Foto scaricata con GPS applicato!\n\nLat: '+lat+'\nLon: '+lon+'\n\nPuoi anche usarla per trasferire i metadati ad altre foto.');let html=document.getElementById('metadataInfo').innerHTML;html=html.replace(/<div class="metadata-row"><span class="metadata-label">🌍 GPS:<\/span><span class="metadata-value"[^>]*>.*?<\/span><\/div>/,'<div class="metadata-row"><span class="metadata-label">🌍 GPS:</span><span class="metadata-value" style="color:#4caf50">Lat: '+lat+', Lon: '+lon+'</span></div>');document.getElementById('metadataInfo').innerHTML=html}catch(err){console.error(err);document.getElementById('loading').classList.remove('show');alert('❌ Errore durante l\'applicazione del GPS.\n\nVerifica i dati inseriti.')}},applyMetadataToTarget(e){const file=e.target.files[0];if(!file)return;if(!this.sourceMetadata){alert('⚠️ Carica prima la foto sorgente!');return}document.getElementById('loading').classList.add('show');document.getElementById('loadingText').textContent='Applicazione metadati...';const reader=new FileReader();reader.onload=ev=>{try{const inserted=piexif.insert(this.sourceMetadata.exifBytes,ev.target.result);const link=document.createElement('a');link.href=inserted;link.download='foto_con_metadati_'+new Date().getTime()+'.jpg';link.click();document.getElementById('loading').classList.remove('show');alert('✅ Foto scaricata con successo!\n\nI metadati EXIF sono stati trasferiti.')}catch(err){console.error(err);document.getElementById('loading').classList.remove('show');alert('❌ Errore durante l\'applicazione.\n\nAssicurati che siano entrambe JPEG.')}e.target.value=''};reader.readAsDataURL(file)}};window.onload=()=>app.init();
</script>
</body>
</html>
